@using MindCabinet.Client.Components.Application.Renders;
@using MindCabinet.Client.Services;
@using MindCabinet.Shared.DataObjects;
@using MindCabinet.Shared.DataObjects.Term;
@using System.Threading.Tasks



<div component-name="TermSearch"
        class="basic @(this.Disabled ? "disabled" : null) @(this.AddedClasses ?? "")">
    <input type="text"
            disabled=@this.Disabled
            @onfocusin=@(e => this.IsSeachFocused = true)
            @onfocusout=@(e => this.IsSeachFocused = false)
            @onkeydown=@this.OnInputKey_UI_Async
            @onkeypress:preventDefault=@this.IsCurrentInputSuppressed
            @bind:event="oninput"
            @bind:get=@this.Value
            @bind:set=@this.OnInputSearch_UI_Async />
            @* @oninput=@(async e => await this.UpdateTermSearchResults_UI_Async(e.Value?.ToString() ?? "")) /> *@
    <div>
        <div style="position: absolute; display: inline-block;">
            @if( this.IsSeachFocused && this.SearchOptions.Count() > 0 ) {
                <MultiTermRender
                        Terms=@this.SearchOptions
                        OnClick_Async=@(async (t, _) => await this.SelectSearchResults_UI_Async(t)) />
            }
       </div>
    </div>
    @if( this.FavoriteTerms_Cache.Count() > 0 ) {
        <div>
            <label>Favorite Terms:</label>
            <MultiTermRender
                    Terms=@this.FavoriteTerms_Cache
                    OnClick_Async=@(async (t, _) => await this.SelectSearchResults_UI_Async(t)) />
        </div>
    }
    @if( this.RecentTerms_Cache.Count() > 0 ) {
        <div>
            <label>Recent Terms:</label>
            <MultiTermRender
                    Terms=@this.RecentTerms_Cache
                    OnClick_Async=@(async (t, _) => await this.SelectSearchResults_UI_Async(t)) />
        </div>
    }
</div>


@code {
    private async Task OnInputKey_UI_Async( KeyboardEventArgs arg ) {
        if( this.Disabled ) {
            return;
        }
        if( !this.IsSeachFocused ) {
            return;
        }

        await this.HandleInput_Async( arg );
    }

    private async Task OnInputSearch_UI_Async( string? termText ) {
        if( this.Disabled ) {
            return;
        }

        if( termText is null ) {
            this.SearchOptions = new List<TermObject>();
        } else {
            await this.SearchAndStoreTerms_Async( termText );
        }
    }

    private async Task SelectSearchResults_UI_Async( TermObject term ) {
        if( this.Disabled ) {
            return;
        }
        if( !this.IsSeachFocused ) {
            return;
        }

        this.SearchOptions = new List<TermObject>();

        await this.SelectSearchResults_Async( term );
    }
}
