@using Microsoft.AspNetCore.Components;
@using MindCabinet.Client.Components.Standard;



<Modal @ref=this.ModalElement
        ModalId=@this.MyModalId
        Title="Create new user"
        AddedClasses=@this.AddedClasses
        AddedStyles=@this.AddedStyles>
    <HeaderContent>
        @* <h4 class="modal-title">Login as user</h4> *@
    </HeaderContent>
    <BodyContent>
        <input type="text"
                title="Enter user name"
                placeholder="User name"
                disabled=@this.CanEditInputs
                @onkeydown=@this.OnInputKey_UI_Async
                @bind:event="oninput"
                @bind:get=@this.UserName
                @bind:set=@this.OnInputUserName_UI_Async />
        <br />
        <input type="email"
                title="Enter email"
                placeholder="Email"
                disabled=@this.CanEditInputs
                @onkeydown=@this.OnInputKey_UI_Async
                @bind:event="oninput"
                @bind:get=@this.Email
                @bind:set=@this.OnInputEmail_UI_Async />
        <br />
        <input type="password"
                title="Enter password"
                placeholder="Password"
                disabled=@this.CanEditInputs
                @onkeydown=@this.OnInputKey_UI_Async
                @bind:event="oninput"
                @bind:get=@this.Password
                @bind:set=@this.OnInputPassword_UI_Async />
                @* @bind:set=this.OnInputPassword_UI_Async /> *@
        <br />
        <div>@( this.GetSubmitStatuses( this.GetSubmitStatusCode() ).FirstOrDefault() ?? " " )</div>
        <button disabled=@this.SubmitDisabled @onclick=@this.Submit_UI_Async>Submit</button>
    </BodyContent>
    <FooterContent>
        @this.RegistrationStatus
    </FooterContent>
</Modal>



@code {
    public bool SubmitDisabled => !this.CanSubmit();

    public bool CanEditInputs => !this.HasRegistered;



    public RenderFragment GenerateDialogOpener() {
        return this.ModalElement.GenerateDialogOpener( buttonLabel: "Sign Up" );
    }

    private async Task OnInputKey_UI_Async( KeyboardEventArgs arg ) {
        if( arg.Code == "Enter" || arg.Code == "NumpadEnter" ) {
            if( this.CanSubmit() ) {
                await this.Submit_UI_Async();
            }

            return;
        }
    }


    public string GetClasses() {
        string classes = "modal";
        if( this.AddedClasses is not null ) {
            classes += " " + this.AddedClasses;
        }
        return classes;
    }

    private async Task OnInputUserName_UI_Async( string val ) {
        bool hasChanged = this.UserName != val;

        this.UserName = val ?? "";

        if( hasChanged ) {
            this.StateHasChanged();
        }
    }

    private async Task OnInputEmail_UI_Async( string val ) {
        bool hasChanged = this.Email != val;

        this.Email = val ?? "";

        if( hasChanged ) {
            this.StateHasChanged();
        }
    }

    private async Task OnInputPassword_UI_Async( string val ) {
        bool hasChanged = this.Password != val;

        this.Password = val ?? "";

        if( hasChanged ) {
            this.StateHasChanged();
        }
    }


    private async Task<bool> Submit_UI_Async() {
        (bool success, string status) = await this.Submit_Async( this.UserName, this.Email, this.Password );

        if( success ) {
            //this.UserName = "";
            //this.Email = "";
            //this.Password = "";

            this.HasRegistered = true;
        }

        this.RegistrationStatus = status;

        //this.ModalElement.Close();

        return success;
    }
}
